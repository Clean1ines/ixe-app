# Примеры архитектурных решений и рефакторинга в ixe-app

Этот документ иллюстрирует ключевые архитектурные решения и рефакторинги, выполненные в проекте, с акцентом на применение SOLID, DDD и TDD.

## 1. Принцип инверсии зависимостей (DIP) в `ImageScriptProcessor`

### Проблема
`ImageScriptProcessor` напрямую зависел от конкретной инфраструктурной детали — `playwright.Page` — для загрузки изображений. Это нарушало DIP, так как модуль высокого уровня (процессор HTML) зависел от модуля низкого уровня (конкретный браузерный API). Это затрудняло тестирование и изменение способа загрузки.

### Решение
1.  Введен интерфейс `IAssetDownloader` в доменном слое (или на границе инфраструктуры).
2.  Создана реализация `PlaywrightAssetDownloaderAdapter`, которая инкапсулирует работу с `playwright.Page.request.get`.
3.  `ImageScriptProcessor` теперь зависит от абстракции `IAssetDownloader`, получая её через конструктор или контекст.
4.  `PageScrapingService` отвечает за создание `PlaywrightAssetDownloaderAdapter` и передачу его в процессор.

### Польза
*   **Тестируемость:** `ImageScriptProcessor` можно легко тестировать с моком `IAssetDownloader`.
*   **Гибкость:** Можно легко заменить способ загрузки (например, на `httpx` или `requests`) без изменения `ImageScriptProcessor`.
*   **Соблюдение DIP:** Зависимости направлены к абстракциям.

**См. коммит:** `122cc9838d31ab6c777dfaacecf1f20a7449e43b`

## 2. Выделение валидации в `Problem.__post_init__`

### Проблема
Метод `__post_init__` в `Problem` содержал логику инициализации *и* проверки инвариантов (например, `if not self.text.strip(): ...`), что делало его перегруженным и нарушало Принцип единственной ответственности (SRP).

### Решение
1.  Создан интерфейс `IProblemValidator`.
2.  Реализованы конкретные валидаторы: `TextValidator`, `DifficultyValidator`, `TaskNumberValidator`, `ExamPartValidator`.
3.  Создан композитный валидатор `CompositeProblemValidator` для объединения всех проверок.
4.  `Problem.__post_init__` теперь использует `CompositeProblemValidator` для выполнения всех проверок.

### Польза
*   **SRP:** `Problem` отвечает за хранение данных, валидация вынесена.
*   **OCP (Открыт/Закрыт):** Легко добавить новую валидацию, не изменяя `Problem`.
*   **Тестируемость:** Каждый валидатор можно тестировать изолированно.
*   **Читаемость:** Логика валидации структурирована.

**См. коммит:** `68c0cf3a2d2ccf10c8d785a8465e0761fcb911df`

## 3. Обработка `qblock` с общим контекстом в `extract_block_pairs`

### Проблема
Страницы ФИПИ могут содержать `div.qblock` без `id`, являющийся общим текстом/контекстом для нескольких последующих `div.qblock` с `id`. Старая логика просто искала пары `header`/`body`, не учитывая эту группировку.

### Решение
1.  Метод `extract_block_pairs` был переписан/расширен.
2.  Добавлена логика для идентификации `qblock` без ID как "общий контекст".
3.  Все последующие `qblock` с ID (до следующего общего контекста или конца списка) ассоциируются с этим контекстом.
4.  Возвращаются пары `(header, body)`, где `body` может содержать объединённый HTML общего контекста и индивидуального `qblock`.

### Польза
*   **Корректность данных:** Позволяет корректно сохранить связь между общим контекстом и индивидуальными заданиями.
*   **Адекватное отображение:** В PWA можно отобразить общий текст перед группой заданий.
*   **Поддержка сложных структур:** Архитектура адаптируется к сложной структуре данных ФИПИ.

**См. коммит:** `f3e77e6462aef1291612b278f0cd87af44f11e13`

## 4. Применение TDD при рефакторинге

### Принцип
Во всех описанных выше случаях (и других) сначала создавались/обновлялись тесты, подтверждающие *текущее* поведение или проверяющие *ожидаемое* поведение *после* рефакторинга. Рефакторинг считался успешным, если все тесты проходили.

### Польза
*   **Безопасность:** Уверенность, что изменения не сломали существующую функциональность.
*   **Дизайн:** Тесты помогают думать о том, *как* должен выглядеть интерфейс компонента.
*   **Документация:** Тесты служат живой документацией о том, *как* работает код.

